#include "Form.h"

void Form::Run()
{
	//////////////////////////////////////////////////////////////////////////////
	//
	InitializeForm();
	//
	//////////////////////////////////////////////////////////////////////////////

	//////////////////////////////////////////////////////////////////////////////
	//
	OnCreate();
	//
	//////////////////////////////////////////////////////////////////////////////

	window.create(sf::VideoMode(GetSize().x, GetSize().y), GetTitle(), GetStyle());
	if (GetPosition().x != -1 && GetPosition().y != -1)
		window.setPosition(GetPosition());
	sf::Mouse::setPosition(sf::Vector2i(GetPosition().x + GetSize().x / 2, GetPosition().y + GetSize().y / 2), window);

	//////////////////////////////////////////////////////////////////////////////
	//
	OnLoad();
	//
	//////////////////////////////////////////////////////////////////////////////

	// Timing
	sf::Clock clock;
	clock.restart();
	float dt = 0.0f;

	while (run && window.isOpen())
	{
		sf::Event event;

		if (GetWaitEvent())
		{
			sf::sleep(sf::milliseconds(GetWaitTime()));

			if(window.waitEvent(event))
				ProcessEvent(event);
		}
		else
		{
			while (window.pollEvent(event))
				ProcessEvent(event);
		}

		//
		// Timing
		//
		dt = clock.restart().asSeconds();

		//////////////////////////////////////////////////////////////////////////////
		//
		OnUpdate(dt);
		//
		//////////////////////////////////////////////////////////////////////////////
		
		window.clear(sf::Color(212, 208, 200));
		//////////////////////////////////////////////////////////////////////////////
		//
		OnDraw();
		//
		//////////////////////////////////////////////////////////////////////////////
		window.display();
	}

	//////////////////////////////////////////////////////////////////////////////
	//
	OnDestroy();
	//
	//////////////////////////////////////////////////////////////////////////////

}

void Form::ProcessEvent(sf::Event & event)
{
	if (event.type == sf::Event::Closed)
	{
		//////////////////////////////////////////////////////////////////////////////
		//
		OnUnload();
		//
		//////////////////////////////////////////////////////////////////////////////

		window.close();
	}

	if (event.type == sf::Event::MouseMoved)
	{
		//////////////////////////////////////////////////////////////////////////////
		//
		OnMouseMove();
		//
		//////////////////////////////////////////////////////////////////////////////
	}

	//////////////////////////////////////////////////////////////////////////////
	//
	OnEvent(event);
	//
	//////////////////////////////////////////////////////////////////////////////
}

std::string Form::GetTitle()
{
	return title;
}

void Form::SetTitle(std::string title)
{
	this->title = title;
}

sf::Vector2i Form::GetSize()
{
	return size;
}

void Form::SetSize(sf::Vector2i size)
{
	this->size = size;
}

sf::Vector2i Form::GetPosition()
{
	return position;
}

void Form::SetPosition(sf::Vector2i position)
{
	this->position = position;
}

int Form::GetStyle()
{
	return style;
}

void Form::SetStyle(int style)
{
	this->style = style;
	// TODO: Must recreate the window in order to change style AFTER it is created.
}

sf::Vector2f Form::GetMousePosition()
{
	float mx = (float)sf::Mouse::getPosition().x - this->window.getPosition().x;
	float my = (float)sf::Mouse::getPosition().y - this->window.getPosition().y;
	return sf::Vector2f(mx, my);
}
